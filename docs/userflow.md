# 콘서트 예매 시스템: 최종 유저플로우

## 1. 콘서트 목록 조회 및 탐색

**입력**

* 홈페이지(콘서트 목록) 접근
* 검색어 입력
* 필터 조건 선택 (예: 장르, 지역, 기간)
* 정렬 기준 선택 (예: 최신순, 마감 임박순)
* 특정 콘서트 선택

**처리**

* DB에서 현재 예매 가능한 상태(`published`)의 콘서트 목록 조회
* 검색어, 필터, 정렬 조건이 있는 경우, 쿼리에 반영하여 결과 필터링 및 정렬
* **(엣지케이스)** 조회 결과가 없을 경우, 빈 목록 상태로 처리
* **(엣지케이스)** 결과가 많을 경우, 페이지네이션(Pagination) 처리

**출력**

* 필터링 및 정렬된 콘서트 목록 표시
* 각 콘서트의 대표 이미지, 제목, 기간, 장소 등 요약 정보 출력
* 조회 결과가 없을 경우, 목록 없음 안내 표시
* 선택한 콘서트의 상세 페이지로 이동

---

## 2. 콘서트 상세 정보 확인 및 인원 선택

**입력**

* 콘서트 상세 페이지 진입
* 예매 인원 수 선택 (증감 버튼 또는 드롭다운)
* '예약하기' 버튼 클릭

**처리**

* 콘서트 ID를 기반으로 상세 정보(소개, 등급별 가격, 등급별 **실시간 잔여 좌석**)를 DB에서 조회
* 선택한 인원 수가 **1회 최대 예매 가능 매수**(정책값, 예: 6매)를 초과하는지 검증
* 선택한 인원 수가 **전체 잔여 좌석 수**보다 많은지 검증
* **(엣지케이스)** 페이지에 진입한 순간 잔여 좌석이 0일 경우, 인원 선택 및 예약하기 버튼을 비활성화 처리
* **(엣지케이스)** 사용자가 인원을 선택하는 동안 실시간 좌석 변동(감소)이 발생했을 때, 선택한 인원 수가 남은 좌석을 초과하면 오류를 알리고 선택을 초기화하거나 조정
* 인원 수가 1 이상이고 유효한 범위 내에 있을 때, '예약하기' 버튼을 활성화 상태로 변경

**출력**

* 콘서트 상세 정보 출력
* 등급별 가격 및 실시간 잔여 좌석 수 출력
* 선택된 인원 수가 UI에 반영
* '예약하기' 버튼의 활성화/비활성화 상태가 실시간으로 변경
* '예약하기' 버튼 클릭 시, 선택한 인원 수와 콘서트 정보를 다음 **좌석 선택 페이지**로 전달하며 이동

---

## 3. 좌석 선택

**입력**

* 좌석 선택 페이지 진입
* 좌석 배치도에서 예매 가능한 좌석 클릭 (선택)
* 이미 선택한 좌석 클릭 (선택 해제)
* '예약하기' 버튼 클릭

**처리**

* 이전 페이지에서 전달받은 콘서트 ID와 인원수 정보를 기반으로, 해당 콘서트의 **실시간 좌석 상태** (예매 가능, 예매 완료, 선택 불가) 데이터를 조회
* 사용자가 좌석을 선택할 때마다 다음을 검증:
    1.  해당 좌석이 '예매 가능' 상태인지 확인
    2.  현재 선택한 좌석의 총 개수가 전달받은 '인원수'를 초과하지 않는지 확인
* 유효한 선택일 경우, 해당 좌석을 현재 사용자의 세션에 임시 '선점' 상태로 변경하고, 세션 타임아웃(예: 10분)을 설정
* **(엣지케이스)** 사용자가 선택을 진행하는 도중 다른 사용자가 해당 좌석을 먼저 예매 완료(결제)한 경우, 실시간으로 해당 좌석을 '예매 완료' 상태로 변경하고 사용자에게 알림
* **(엣지케이스)** 세션 타임아웃이 만료되면, 선점했던 모든 좌석을 '예매 가능' 상태로 되돌리고 사용자에게 세션 만료를 알림
* 선택한 좌석의 총 개수가 '인원수'와 정확히 일치할 때, '예약하기' 버튼을 활성화. 그 외의 경우에는 비활성화
* '예약하기' 버튼 클릭 시, 최종적으로 선택한 좌석들이 여전히 '예매 가능'한지 다시 한번 검증

**출력**

* 좌석 배치도를 등급별/상태별(예매 가능, 예매 완료, 내 선택)로 시각화하여 출력
* 사용자가 선택한 좌석의 상세 정보(등급, 행/열, 가격) 목록과 계산된 총 결제 금액을 실시간으로 표시
* 선택한 좌석 수에 따라 '예약하기' 버튼의 활성화 상태를 변경
* **(엣지케이스 발생 시)** 좌석 선점 실패, 세션 만료 등에 대한 피드백 메시지를 사용자에게 노출
* 최종 검증 통과 시, 선택된 좌석 정보를 다음 **예약 정보 입력 페이지**로 전달하며 이동

---

## 4. 예약 정보 입력

**입력**

* 예약 정보 입력 페이지 진입
* 선택한 좌석별로 예매자 정보(이름, 휴대폰 번호) 및 조회용 비밀번호(4자리 숫자) 입력
* '입력 완료하기' 버튼 클릭

**처리**

* 이전 페이지에서 전달받은 선택 좌석 정보를 화면에 표시
* 각 입력 필드의 유효성을 실시간으로 검증:
    * 이름: 빈 값인지 확인
    * 휴대폰 번호: 유효한 형식(예: `010-1234-5678`)인지 확인
    * 비밀번호: 4자리 숫자인지 확인
* 모든 필수 입력 필드가 유효한 값으로 채워졌는지 전체 양식의 유효성을 검증
* 전체 양식이 유효할 경우에만 '입력 완료하기' 버튼을 활성화 상태로 변경
* '입력 완료하기' 버튼 클릭 시, 임시 선점했던 좌석의 세션 유효 시간을 최종 확인
    * **(엣지케이스)** 세션이 만료된 경우, 예약을 중단하고 좌석을 다시 선택하도록 안내

**출력**

* 선택한 좌석 정보 목록을 화면에 출력
* 각 좌석에 대한 정보 입력 UI를 제공
* 양식의 유효성 상태에 따라 '입력 완료하기' 버튼의 활성화/비활성화 상태를 실시간으로 변경
* **(엣지케이스 발생 시)** 세션 만료 또는 데이터 오류에 대한 피드백 메시지 노출
* 최종 확인 후, 모든 예매 정보를 다음 **예약 완료 페이지**로 전달하며 이동

---

## 5. 예약 완료 및 확정

**입력**

* 예약 정보 입력 페이지에서 '입력 완료하기' 버튼 클릭

**처리**

* 데이터베이스 트랜잭션(Transaction)을 시작
* **최종 좌석 상태를 다시 한번 검증**하여, 다른 사용자에 의해 예매되지 않았는지 확인
* **예매(Booking) 레코드를 데이터베이스에 생성**하고, 고유 예약번호를 발급
* 예매 레코드에 콘서트 정보, 좌석 정보, 예매자 정보, 예약 일시, 결제 금액을 저장
* **좌석 테이블의 해당 좌석 상태를 '예매 완료'로 영구적으로 변경**
* 데이터베이스 트랜잭션을 종료(Commit)
* **(엣지케이스)** 최종 좌석 검증 단계에서 좌석이 이미 판매된 것으로 확인될 경우(Race Condition), 트랜잭션을 롤백(Rollback)하고 예약 실패 처리
* **(엣지케이스)** 데이터베이스 쓰기 작업 중 오류가 발생할 경우, 트랜잭션을 롤백하고 예약 실패 처리

**출력**

* 예약 완료 페이지로 이동
* 생성된 **고유 예약번호**를 포함한 모든 예약 상세 정보(콘서트 정보, 좌석, 예매자, 결제 금액, 예약 일시)를 화면에 출력
* 예약 실패 시, 사용자에게 좌석 선점에 실패했다는 메시지를 명확히 알리고, 다시 시도하도록 유도 (예: 좌석 선택 페이지로 이동)
* 페이지 하단에 '홈으로 돌아가기', '예약 조회하기' 등 다음 행동을 위한 네비게이션 버튼을 제공

---

## 6. 예약 조회

**입력**

* 예약 조회 페이지 진입
* 예매 시 입력했던 식별 정보(휴대폰 번호) 및 조회용 비밀번호 입력
* '조회하기' 버튼 클릭

**처리**

* 입력된 휴대폰 번호와 비밀번호의 형식이 유효한지 검증
* 데이터베이스에서 입력된 정보와 일치하는 예매(Booking) 레코드를 검색
* **(엣지케이스)** 일치하는 예매 정보가 없을 경우, 조회 실패로 처리
* **(엣지케이스)** 한 개의 식별 정보(휴대폰 번호)로 여러 건의 예매 내역이 존재할 경우, 해당되는 모든 예매 목록을 반환

**출력**

* 조회 성공 시, 해당 정보로 예매된 콘서트 목록을 배너 형태로 출력
* 각 배너에는 예매 상세 정보(콘서트명, 좌석, 예매일 등)와 '예약 취소' 버튼을 포함
* 조회 실패 시, '입력하신 정보와 일치하는 예매 내역이 없습니다.' 와 같은 피드백 메시지를 노출

---

## 7. 예약 취소

**입력**

* 조회된 예매 내역에서 '예약 취소' 버튼 클릭
* 확인 경고창(Confirm Modal)에서 최종 '예약 취소' 버튼 클릭

**처리**

* 사용자가 취소를 요청한 예매 건의 고유 ID를 식별
* **플랫폼의 환불/취소 정책을 확인**하여 현재 시점에서 취소가 가능한지 검증
    * **(엣지케이스)** 취소 불가 기간(예: 공연 당일)일 경우, 요청을 거부하고 실패 처리
* 데이터베이스 트랜잭션을 시작
    1.  예매(Booking) 테이블에서 해당 레코드의 상태를 '취소'로 변경
    2.  좌석(Seat) 테이블에서 해당 예매 건과 연결된 모든 좌석의 상태를 '예매 완료'에서 다시 '**예매 가능**'으로 변경
* 데이터베이스 트랜잭션을 종료(Commit)
* **(엣지케이스)** 처리 중 데이터베이스 오류 발생 시, 트랜잭션을 롤백(Rollback)하여 데이터 불일치를 방지하고 실패 처리

**출력**

* 첫 '예약 취소' 버튼 클릭 시, 작업을 재확인하는 경고창을 노출
* 최종 취소 성공 시:
    * 취소가 완료되었다는 피드백 메시지를 표시
    * 예약 조회 목록에서 해당 예매 내역 배너를 제거하거나 '취소된 예매' 상태로 변경하여 표시
* 취소 실패 시 (예: 정책 위반), 취소가 불가능한 사유를 명확히 안내하는 피드백 메시지를 노출